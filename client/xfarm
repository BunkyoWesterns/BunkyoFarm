#!/usr/bin/env python3

import typer
from typing import Annotated
from enum import Enum
from rich import print

from rich.console import Console
from rich.table import Table

from exploitfarm.utils import *
from exploitfarm.utils.cmd import *

app = typer.Typer(
    no_args_is_help=True,
    add_completion=False
)
console = Console()

state = {"interactive": True}

class g:
    config: ClientConfig = ClientConfig.read()

def initial_setup():
    inital_config_setup(g.config)
        
"""
def table_test():
    table = Table("Name", "Item")
    table.add_row("Rick", "Portal Gun")
    table.add_row("Morty", "Plumbus")
    console.print(table)

class Option(str, Enum):
    init = "init"
    login = "login"
    start = "start"
    reset = "reset"
    config = "config"

valid_commands = map(lambda x: x.value, list(Option))

def complete_command(incomplete: str):
    completion = []
    for name in valid_commands:
        if name.startswith(incomplete):
            completion.append(name)
    return completion
"""

@app.command(help="Configure the client settings")
def config(
    address: str = typer.Option(None, help="The address of the server"),
    port: int = typer.Option(None, help="The port of the server"),
    nickname: str = typer.Option(None, help="The nickname of this client"),
    https: bool = typer.Option(False, help="Use HTTPS for the connection"),
    skip_connection_test: bool = typer.Option(False, help="Skip the connection test"),
):
    if state["interactive"]:
        InitialConfiguration(g.config).run()
    else:
        if address:
            g.config.server.address = address
        if port:
            g.config.server.port = port
        if nickname:
            g.config.client_name = nickname
        if https:
            g.config.server.https = https
        if skip_connection_test:
            g.config.ignore_connection_failed = skip_connection_test
        elif not g.config.test_server():
            print(f"[bold red]Connection test failed to {get_url("//", g.config)}[/]")
            return
        g.config.write()
        print("[bold green]Config updated[/]")

@app.command(help="Reset the client settings")
def reset():
    delete = typer.confirm("Are you sure you want to reset configs? (This may break some exploits running on the client)")
    if delete:
        ClientConfig().write()
        print("[bold red]Reset successful[/]")
    else:
        print("[bold]Reset cancelled[/]")

@app.command()
def start():
    initial_setup()
    print({
        "message": "start"
    })

@app.command()
def login():
    initial_setup()
    print({
        "message": "login"
    })

@app.command()
def init():
    initial_setup()
    print({
        "message": "init"
    })

@app.callback()
def main(interactive: bool = typer.Option(True, help="Interactive configuration mode", envvar="XFARM_INTERACTIVE")):
    state["interactive"] = interactive

if __name__ == "__main__":
    app()
