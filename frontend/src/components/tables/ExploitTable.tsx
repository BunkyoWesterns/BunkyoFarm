import { exploitsQuery, useClientSolver, useServiceSolver } from "@/utils/queries";
import { getDateSmallFormatted } from "@/utils/time";
import { Box, Table, Title } from "@mantine/core";
import { DeleteButton, EditButton } from "@/components/inputs/Buttons";
import { Exploit } from "@/utils/types";
import { useState } from "react";
import { StatusPoint } from "../elements/ExploitsBar";
import { DeleteExploitModal } from "../modals/DeleteExploitModal";
import { EditExploitModal } from "../modals/EditExploitModal";


export const ExploitTable = () => {

    const exploits = exploitsQuery()
    const getServiceName = useServiceSolver()
    const getClientName = useClientSolver()

    const [deleteExploit, setDeleteExploit] = useState<Exploit|undefined>()
    const [editExploit, setEditExploit] = useState<Exploit|undefined>()

    const rows = exploits.data?.map((expl) => {
        return <Table.Tr key={expl.id}>
            <Table.Td><StatusPoint status={expl.status} /></Table.Td>
            <Table.Td style={{width:"100%"}}><Box>{expl.name}</Box></Table.Td>
            <Table.Td><Box>{getServiceName(expl.service)}</Box></Table.Td>
            <Table.Td><Box>{expl.language}</Box></Table.Td>
            <Table.Td><Box>{getClientName(expl.last_execution_by)}</Box></Table.Td>
            <Table.Td><Box>{expl.last_update?getDateSmallFormatted(expl.last_update):"Not started"}</Box></Table.Td>
            <Table.Td><EditButton onClick={()=>setEditExploit(expl)} /></Table.Td>
            <Table.Td><DeleteButton onClick={()=>setDeleteExploit(expl)} /></Table.Td>
        </Table.Tr>
    })??[];

    return <>
        <Table>
            <Table.Thead>
                <Table.Tr style={{fontSize: "120%"}}>
                    <Table.Th style={{whiteSpace:"nowrap"}}><StatusPoint /></Table.Th>
                    <Table.Th style={{whiteSpace:"nowrap"}}>Name</Table.Th>
                    <Table.Th style={{whiteSpace:"nowrap"}}>Service</Table.Th>
                    <Table.Th style={{whiteSpace:"nowrap"}}>Language</Table.Th>
                    <Table.Th style={{whiteSpace:"nowrap"}}>Executed by</Table.Th>
                    <Table.Th style={{whiteSpace:"nowrap"}}>Last Execution</Table.Th>
                    <Table.Th style={{whiteSpace:"nowrap"}}>Edit</Table.Th>
                    <Table.Th style={{whiteSpace:"nowrap"}}>Delete</Table.Th>
                </Table.Tr>
            </Table.Thead>
            <Table.Tbody>{rows}</Table.Tbody>
        </Table>
        <Box className="center-flex" mt={10}>{rows.length == 0 && <Title order={4}>No exploit found</Title>}</Box>
        <DeleteExploitModal exploit={deleteExploit} onClose={()=>setDeleteExploit(undefined)} />
        <EditExploitModal exploit={editExploit} onClose={()=>setEditExploit(undefined)} />
    </>
}

